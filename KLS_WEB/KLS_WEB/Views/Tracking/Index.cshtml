@model KLS_WEB.Models.Tracking.TrackingDTO

<style>
    .card {
        box-shadow: 0px 0px 10px 0px rgb(0 0 0 / 20%) !important;
    }

    .filter-option-inner-inner {
        text-transform: uppercase !important;
        font-size: 12px !important;
    }

    td {
        font-size: 12px !important;
    }

    p {
        margin-bottom: 0 !important;
    }

    .custom-filter {
        cursor: pointer;
    }
</style>

<div class="p-3">
    <div class="d-flex flex-row justify-content-between mb-2">
        <div class="w-25 my-auto">
            <h3>MONITOREO</h3>
        </div>
        <div class="w-50 d-flex flex-row justify-content-end">
            <div class="card text-center w-25 mr-3 custom-filter" onclick="DT(null, 'status', true, 2)">
                <div class="card-body size-12">
                    <b>@Model.Confirmados</b>
                    <p class="text-light-grey">CONFIRMADOS</p>
                </div>
            </div>
            <div class="card text-center w-25 mr-3 custom-filter" onclick="DT(null, 'status', true, 3)">
                <div class="card-body size-12">
                    <b>@Model.EnTransito</b>
                    <p class="text-light-grey">EN TRÁNSITO</p>
                </div>
            </div>
            <div class="card text-center w-25 custom-filter" onclick="DT(null, 'substatus', true, 9)">
                <div class="card-body size-12">
                    <b>@Model.Demorados</b>
                    <p class="text-light-grey">DEMORADOS</p>
                </div>
            </div>
        </div>
    </div>

    <div class="card">
        <div class="card-body">
            <div class="row mb-3">
                <div class="col-3">
                    <label class="form-label size-14">CLIENTE</label>
                    <select asp-items="Model.Selects.Customers" multiple="multiple" name="customers[]" class="form-select" onchange="DT(null, this)" style="width: 100%;" data-selected-text-format="count" data-live-search="true"></select>
                </div>
                <div class="col-3">
                    <label class="form-label size-14">ESTATUS</label>
                    <select asp-items="Model.Selects.Statuses" class="form-select" onchange="DT(null, 'status', true, this.value), GetSubstatuses(this.value)" style="width: 100%;" data-live-search="true"></select>
                </div>
                <div class="col-3">
                    <label class="form-label size-14">SUBESTATUS</label>
                    <select id="substatuses" class="form-select" onchange="DT(null, 'substatus', true, this.value)" style="width: 100%;" data-live-search="true"></select>
                </div>
                <div class="col-3">
                    <label class="form-label size-14">VIAJE</label>
                    <input type="text" class="form-control" onkeyup="DT(this.value)">
                </div>
            </div>
            <table id="table" class="table table-striped table-bordered display table-hover table-viajes text-uppercase" width="100%">
                <thead>
                    <tr>
                        @*<th>ID Viaje</th>*@
                        <th>Cliente</th>
                        <th>Origen</th>
                        <th>Fecha</th>
                        <th>Contacto</th>
                        <th>Estatus</th>
                        <th>Acciones</th>
                    </tr>
                </thead>
                <tbody></tbody>
            </table>
        </div>
    </div>
</div>

<div class="modal fade" id="comentarioModal" tabindex="-1" role="dialog" aria-labelledby="exampleModalLabel" aria-hidden="true">
    <div class="modal-dialog" role="document">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="exampleModalLabel">AGREGAR COMENTARIO MONITOREO</h5>
                <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                    <span aria-hidden="true">&times;</span>
                </button>
            </div>
            <div class="modal-body">
                <form onsubmit="event.preventDefault(), PostSectionComment(this)">
                    <input type="hidden" name="SectionId" />
                    <div class="row">
                        <div class="col-6">
                            <label class="form-label size-14">ESTATUS</label>
                            <select asp-items="Model.Selects.Statuses" name="statusid" class="form-select" onchange="GetSubstatuses(this.value, true)" style="width: 100%;" data-live-search="true"></select>
                        </div>
                        <div class="col-6">
                            <label class="form-label size-14">SUBESTATUS</label>
                            <select name="substatusid" class="form-select" style="width: 100%;" data-live-search="true"></select>
                        </div>
                    </div>
                    <br />
                    <div class="row">
                        <div class="col-md-12">
                            <label>COMENTARIO</label>
                            <textarea class="form-control" rows="6" name="comment"></textarea>
                        </div>
                    </div>
                    <div class="row">
                        <div class="col-12">
                            <label>GRUPO MONITOR</label>
                            <input class="form-control" name="grupomonitor" />
                        </div>
                    </div>
                    <br />
                    <div class="row">
                        <div class="col-md-12">
                            <label>EVIDENCIA</label>
                            <input type="file" class="form-control" name="file" accept=".jpg,.png" />
                        </div>
                    </div>
                    <br />
                    <div class="row">
                        <div class="col-md-6">
                            <button type="submit" class="btn btn-dark" style="width:100%;">GUARDAR</button>
                        </div>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>

@section Scripts{
    <!-- Latest compiled and minified CSS -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-select@1.13.14/dist/css/bootstrap-select.min.css">
    <!-- Latest compiled and minified JavaScript -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap-select@1.13.14/dist/js/bootstrap-select.min.js"></script>
    <!-- (Optional) Latest compiled and minified JavaScript translation files -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap-select@1.13.14/dist/js/i18n/defaults-es_ES.min.js"></script>

    <script>
        $(() => {
            $('select').selectpicker();
            DT();
        })

        const GetSubstatuses = async (StatusId, isComment = false) => {
            try {
                const response = await fetch(`/Tracking/GetSubstatuses?StatusId=${StatusId}`);
                const data = await response.json();
                let html = '<option value="0" selected disabled>NO HAY SELECCIÓN</option>';
                data.map(({ id, name }) => html += `<option value="${id}">${name}</option>`);
                $(`${isComment ? "[name=substatusid]" : "#substatuses"}`).html(html).selectpicker('refresh');
            } catch (e) {
                console.error(e);
            }
        }

        const PostSectionComment = async e => {
            const params = {
                method: 'POST',
                body: new FormData(e)
            };

            console.log([...new FormData(e)]);

            try {
                const response = await fetch('/Tracking/AddSectionComment', params);
                const data = await response.json();
                console.log('asdas', data);
            } catch (e) {
                console.error(e);
            }
        }

        const DT = (keyword = null, filter = null, customsearch = false, status = 0) => {
            Table = $('#table').DataTable({
                destroy: true,
                responsive: true,
                autoWidth: true,
                processing: true,
                serverSide: true,
                dom: 'Btp',
                ajax: {
                    type: 'POST',
                    url: '/Tracking/DataTable',
                    data: data => {
                        if (keyword) {
                            data.search.value = keyword;
                        }
                        if (filter && !customsearch) {
                            data.filter = $(filter).val();
                        }
                        if (customsearch && status == 0) {
                            data.customsearch = customsearch;
                            data.SubstatusId = filter;
                        }
                        if (filter && customsearch) {
                            data.customsearch = customsearch;
                            data.SubstatusId = status;
                            data.CSType = filter;
                        }
                    }
                },
                columns: [
                    {
                        render: (data, type, row) => {
                            const { folio, cliente } = row;
                            const html = `<p>FOLIO: ${folio}</p><p>CLIENTE: ${cliente}</p>`;
                            return html;
                        }
                    },
                    {
                        render: (data, type, row) => {
                            const { origen, destino } = row;
                            const html = `<p>ORIGEN: ${origen}</p><p>DESTINO: ${destino}</p>`;
                            return html;
                        }
                    },
                    {
                        render: (data, type, row) => {
                            const { fechaSalida, fechaLlegada } = row;
                            const html = `<p>FECHA SALIDA: ${fechaSalida}</p><p>FECHA LLEGADA: ${fechaLlegada}</p>`;
                            return html;
                        }
                    },
                    {
                        render: (data, type, row) => {
                            const { siguienteContacto, eta, grupoMonitor } = row;
                            const html = `<p>SIGUIENTE CONTACTO EN: ${siguienteContacto}</p><p>ETA: ${eta}</p> <p>GRUPO MONITOR: ${grupoMonitor}</p>`;
                            return html;
                        }
                    },
                    {
                        data: 'status'
                    },
                    {
                        render: (data, type, row) => {
                            const { checkpoint, sectionId } = row;
                            const html = `<a href="javascript:void(0)" onclick="$('#comentarioModal').modal('show'), $('[name=SectionId]').val(${sectionId})"><span class="material-icons">control_point</span></a> <a href="javascript:void(0)" class="d-flex flex-column text-danger"><span class="material-icons">assistant_photo</span>${checkpoint}</a> `;
                            return html;
                        }
                    }
                ],
                language: {
                    url: '/json/dt-es.json'
                },
                columnDefs: [
                    { className: 'd-flex flex-row justify-content-around align-items-center', targets: [5] }
                ],
                initComplete: () => {
                    $('#table_length').html(`<a href="/Travels/AddEdit/0/0" class="btn btn-sm btn-outline-secondary float-right"><span class="material-icons">add</span></a>`).show();
                }
            });
        }
    </script>
}