@model string
<div class="col-6 facturacion">
    <div class="text-left d-flex justify-content-between mb-3">
        <h4>FACTURACIÓN</h4>
        <div style="padding-left:20%;" onclick="selectFactura(this)">
            <a class="btn btn-sm bg-white" style="font-size:1.8rem;width:3.5rem" href="javascript:void(0);">
                <span class="material-icons">
                    add
                </span>
            </a>
        </div>
    </div>

    <table class="table table-striped table-bordered display table-hover text-uppercase table-facturas" width="100%">
        <thead>
            <tr>
                <th>Nombre</th>
                <th>Fecha de carga</th>
                <th>Usuario</th>
                <th>Acciones</th>
            </tr>
        </thead>
        <tbody id="facturacionInfo"></tbody>
    </table>
</div>

<!--Modal agregar factura-->
<div class="modal fade" id="modalFactura" tabindex="-1" role="dialog" data-backdrop="static" data-keyboard="false"
     aria-labelledby="exampleModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-xl modal-dialog-centered" role="document">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="titulo-modal">AGREGAR</h5>
                <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                    <span aria-hidden="true">&times;</span>
                </button>
            </div>
            <div class="modal-body text-left">
                <form id="formFactura" name="form" enctype="multipart/form-data" method="post">
                    <div class="form-group col-12">
                        <div class="custom-file">
                            <input type="file" class="custom-file-input" name="file" id="customFile" required>
                            <label class="custom-file-label" for="customFile">Seleccione un archivo</label>
                        </div>
                    </div>
                    <br />
                    <a href="javascript:void(0);" class="btn btn-dark guardar" style="width:100%"
                       onclick="UploadFile()">
                        Agregar
                    </a>
                </form>
            </div>
        </div>
    </div>
</div>
<!--Modal agregar factura-->

<script src="https://cdnjs.cloudflare.com/ajax/libs/moment.js/2.17.1/moment.min.js"></script>
<script>
    loadTableFactura = () => {
        $('.table-facturas').DataTable().clear().destroy();
        $.get("/Facturacion/getFacturas", { SectionId: @Model }, res => {
            res.map(({ nombre, fechacarga, usuario, fullpath }) => {
                $("#facturacionInfo").append(`
                        <tr>
                        <td>${nombre}</td>
                        <td>${moment(fechacarga).format('DD/MM/YYYY')}</td>
                        <td>${usuario}</td>
                        <td class="text-center">
                            <a href="javascript:void(0);" onclick="downloadFile('${nombre}','${fullpath}')">
                                <span class="material-icons">
                                    file_download
                                </span>
                            </a>
                        </td>
                    </tr>`);
            });
            dTable("table-facturas");
            $('.dataTables_length, .dataTables_filter, .dataTables_info').remove();
        }).fail(error => {
            dToast("error", "Error al tratar de obtener los registros, intenta cerrar sesión y volver a iniciar.", "Error");
        });
    }

    selectFactura = element => {
        const elemento = jQuery(element);
        elemento.attr('disabled', true);
        $("#modalFactura").modal("show");
    }

    UploadFile = () => {
        var formData = new FormData();
        var myfile = $('#customFile')[0].files[0];
        formData.append('file', $('#customFile')[0].files[0]);
        formData.append('SectionId', @Model);
        if (myfile !== undefined) {
            $.ajax({
                url: "/Facturacion/UploadFile",
                type: "POST",
                data: formData,
                contentType: false,
                processData: false,
                success: function (data) {
                    $("#modalDiv .close").click();
                    dToast("success", "Archivo guardado correctamente.", "Exitoso");
                    $('#formFactura')[0].reset();
                    loadTableFactura();
                    $.post('/Travels/SetHistorial', { accion: 'Añadió archivo en facturación' });
                },
                error: data => {
                    dToast("error", "Ocurrio un error al intentar guardar el archivo.", "Error");
                }
            });
        } else {
            dToast("error", "Seleccione un archivo.", "Error");
        }
    }

    downloadFile = (nombre, fullpath) => {
        const a = $("<a>")
            .attr("href", fullpath)
            .attr("download", nombre)
            .appendTo("body");
        a[0].click();
        a.remove();
    }
    loadTableFactura();
</script>