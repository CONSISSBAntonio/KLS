@model KLS_WEB.Models.Travels.Travel

@{
    ViewData["Title"] = "Detalles del viaje";
}
<style>
    .card, .catalog, .bg-white {
        box-shadow: 0px 3px 6px #00000029;
    }

    .dot {
        height: 25px;
        width: 25px;
        background-color: #88C78F;
        border-radius: 50%;
        display: inline-block;
    }

    .catalog-list {
        padding: unset;
        padding-left: inherit;
    }

    .catalog {
        width: 11.2rem !important;
        height: 9.7rem !important;
    }

    label {
        text-align: left;
    }
</style>

<div class="container">
    <div class="row">
        <div class="col-5 d-flex justify-content-start align-content-center">
            <a href="/Travels" class="d-flex align-items-center" style="text-decoration: none !important;">
                <i class="material-icons icon-red">arrow_back</i>
            </a>
            <div class="text-uppercase poppins medium size-24 pl-2">Viaje @Model.Folio</div>
        </div>
        <div class="col-7 d-flex justify-content-center align-items-center">
            <div class="card w-75 h-100 d-flex flex-row justify-content-around">
                <div class="d-flex justify-content-start w-50">
                    <span class="dot my-auto mr-3 ml-3"></span>
                    <h6 class="my-auto justify-content-start">EN TRÁNSITO</h6>
                </div>
                <div class="w-50 d-flex justify-content-center align-items-center">
                    <h6 class="my-auto">A TIEMPO (0HR)</h6>
                </div>
            </div>
        </div>
    </div>


    <div class="row">

        <div class="col-5" style="margin-top: 1.3rem;">
            <div class="card p-3">

                <form id="form">
                    <div class="form-group row">
                        <label class="col-5 col-form-label col-form-label-sm">Folio de viaje</label>
                        <div class="col-7">
                            <input asp-for="Folio" type="text" class="form-control form-control-sm" id="folio" disabled="disabled" required>
                        </div>
                    </div>
                    <div class="form-group row">
                        <label class="col-5 col-form-label col-form-label-sm">Cliente</label>
                        <div class="col-7">
                            <input asp-for="NombreCliente" type="text" class="form-control form-control-sm" id="cliente" disabled="disabled" required>
                        </div>
                    </div>
                    <div class="form-group row">
                        <label class="col-5 col-form-label col-form-label-sm">Dirección Origen</label>
                        <div class="col-7">
                            <input asp-for="DireccionRemitente" type="text" class="form-control form-control-sm" id="direccionorigen" disabled="disabled" required>
                        </div>
                    </div>
                    <div class="form-group row">
                        <label class="col-5 col-form-label col-form-label-sm">Dirección Destino</label>
                        <div class="col-7">
                            <input asp-for="DireccionDestinatario" type="text" class="form-control form-control-sm" id="direcciondestino" disabled="disabled" required>
                        </div>
                    </div>
                    <div class="form-group row">
                        <label class="col-5 col-form-label col-form-label-sm">Ruta</label>
                        <div class="col-7">
                            <input asp-for="NombreRuta" type="text" class="form-control form-control-sm" id="ruta" disabled="disabled" required>
                        </div>
                    </div>
                    <div class="form-group row">
                        <label class="col-5 col-form-label col-form-label-sm">Fecha Salida</label>
                        <div class="col-7">
                            <input asp-for="FechaSalida" type="text" class="form-control form-control-sm" id="fechasalida" disabled="disabled" required>
                        </div>
                    </div>
                    <div class="form-group row">
                        <label class="col-5 col-form-label col-form-label-sm">Fecha Entrega</label>
                        <div class="col-7">
                            <input asp-for="FechaLlegada" type="text" class="form-control form-control-sm" id="fechaentrega" disabled="disabled" required>
                        </div>
                    </div>
                    <div class="form-group row">
                        <label class="col-5 col-form-label col-form-label-sm">Costo</label>
                        <div class="col-7">
                            <input asp-for="Costototal" type="text" class="form-control form-control-sm" id="costo" disabled="disabled" required>
                        </div>
                    </div>
                    <div class="form-group row">
                        <label class="col-5 col-form-label col-form-label-sm">Precio Cliente</label>
                        <div class="col-7">
                            <input asp-for="Preciototal" type="text" class="form-control form-control-sm" id="preciocliente" disabled="disabled" required>
                        </div>
                    </div>
                    <div class="form-group row">
                        <label class="col-5 col-form-label col-form-label-sm">Tipo de Unidad</label>
                        <div class="col-7">
                            <input asp-for="TipoUnidadNombre" type="text" class="form-control form-control-sm" id="tipounidad" disabled="disabled" required>
                        </div>
                    </div>

                </form>

            </div>
        </div>

        <div class="col-7">
            <div class="catalog-list">

                <a href="#" class="catalog" id="servicios">
                    <div class="content">
                        <span class="material-icons">
                            people
                        </span>
                        <div class="name font-barlow">Servicios</div>
                    </div>
                </a>
                <a href="#" class="catalog">
                    <div class="content" id="requisitos">
                        <span class="material-icons">
                            inventory_2
                        </span>
                        <div class="name font-barlow">Requisitos</div>
                    </div>
                </a>
                <a href="#" class="catalog" id="mercancias">
                    <div class="content">
                        <span class="material-icons">
                            store
                        </span>
                        <div class="name font-barlow">Mercancía</div>
                    </div>
                </a>

                <a href="javascript:void(0);" class="catalog" id="facturacion" onclick="{ showPanel(this.id); }">
                    <div class="content">
                        <span class="material-icons">
                            receipt_long
                        </span>
                        <div class="name font-barlow">Facturación</div>
                    </div>
                </a>

                <a href="#" class="catalog" id="documentos">
                    <div class="content">
                        <span class="material-icons">
                            folder
                        </span>
                        <div class="name font-barlow">Documentos</div>
                    </div>
                </a>
                <a href="#" class="catalog" id="historial">
                    <div class="content">
                        <span class="material-icons">
                            manage_search
                        </span>
                        <div class="name font-barlow">Historial</div>
                    </div>
                </a>
                <a href="#" class="catalog">
                    <div class="content">
                        <span class="material-icons">
                            pin_drop
                        </span>
                        <div class="name font-barlow">Monitoreo</div>
                    </div>
                </a>

            </div>
        </div>

    </div>

    <div class="row mt-4 bottomPanel">
        <div class="col-6 facturacion d-none">
            <div class="text-left d-flex justify-content-between mb-3">
                <h4>FACTURACIÓN</h4>
                <div style="padding-left:20%;" onclick="selectServicios(this);">
                    <a class="btn btn-sm bg-white" style="font-size:1.8rem;width:3.5rem" href="#">
                        <span class="material-icons">
                            add
                        </span>
                    </a>
                </div>
            </div>

            <table id="table" class="table table-striped table-bordered display table-hover table-facturas text-uppercase" width="100%">
                <thead>
                    <tr>
                        <th>Nombre</th>
                        <th>Fecha de carga</th>
                        <th>Usuario</th>
                        <th>Acciones</th>
                    </tr>
                </thead>
                <tbody id="table-info"></tbody>
            </table>
        </div>
    </div>
</div>


<!--Modal agregar factura-->
<div class="modal fade" id="modalDiv" tabindex="-1" role="dialog" data-backdrop="static" data-keyboard="false"
     aria-labelledby="exampleModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-xl modal-dialog-centered" role="document">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="titulo-modal">AGREGAR</h5>
                <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                    <span aria-hidden="true">&times;</span>
                </button>
            </div>
            <div class="modal-body text-left">
                <form id="form" name="form" enctype="multipart/form-data" method="post">
                    <div class="form-group col-12">
                        <div class="custom-file">
                            <input type="file" class="custom-file-input" name="file" id="customFile" required>
                            <label class="custom-file-label" for="customFile">Seleccione un archivo</label>
                        </div>
                    </div>
                    <br />
                    <button type="button" class="btn btn-dark guardar" style="width:100%" onclick="UploadFile()">Agregar</button>
                </form>
                @*<form asp-controller="Facturacion" asp-action="UploadFile" method="post" enctype="multipart/form-data">
                        <div class="form-group col-12">
                            <div class="custom-file">
                                <input type="file" class="custom-file-input" name="file" id="customFile">
                                <label class="custom-file-label" for="customFile">Seleccione un archivo</label>
                            </div>
                        </div>
                        <br />
                        <button type="submit" class="btn btn-dark guardar" style="width:100%">Agregar</button>
                    </form>*@
            </div>
        </div>
    </div>
</div>
<!--Modal agregar factura-->

@section Scripts{
    <script src="https://cdnjs.cloudflare.com/ajax/libs/moment.js/2.17.1/moment.min.js"></script>
    <script>
        $(document).ready(function () {
            loadTableFactura();
            $('#servicios').on('click', function () {

                var container = $('#div-servicios');
                $('#div-requisitos').addClass('d-none');
                $('#div-mercancias').addClass('d-none');
                $('#div-facturacion').addClass('d-none');
                $('#div-documentos').addClass('d-none');
                $('#div-historial').addClass('d-none');

                if (container.css('display') == 'none')
                    $('#div-servicios').removeClass('d-none');
                else
                    $('#div-servicios').addClass('d-none');

            });

            $('#requisitos').on('click', function () {

                var container = $('#div-requisitos');
                $('#div-servicios').addClass('d-none');
                $('#div-mercancias').addClass('d-none');
                $('#div-facturacion').addClass('d-none');
                $('#div-documentos').addClass('d-none');
                $('#div-historial').addClass('d-none');

                if (container.css('display') == 'none') {
                    $('#div-requisitos').removeClass('d-none');
                }
                else
                    $('#div-requisitos').addClass('d-none');
            });

            $('#mercancias').on('click', function () {

                var container = $('#div-mercancias');
                $('#div-servicios').addClass('d-none');
                $('#div-requisitos').addClass('d-none');
                $('#div-facturacion').addClass('d-none');
                $('#div-documentos').addClass('d-none');
                $('#div-historial').addClass('d-none');

                if (container.css('display') == 'none')
                    $('#div-mercancias').removeClass('d-none');
                else
                    $('#div-mercancias').addClass('d-none');

            });

            $('#facturacion').on('click', function () {
                var container = $('#div-facturacion');
                $('#div-servicios').addClass('d-none');
                $('#div-requisitos').addClass('d-none');
                $('#div-documentos').addClass('d-none');
                $('#div-mercancias').addClass('d-none');
                $('#div-hostorial').addClass('d-none');

                if (container.css('display') == 'none') {
                    $('#div-facturacion').removeClass('d-none');
                    loadTableFactura();
                }
                else
                    $('#div-facturacion').addClass('d-none');

            });

            $('#documentos').on('click', function () {

                var container = $('#div-documentos');
                $('#div-servicios').addClass('d-none');
                $('#div-requisitos').addClass('d-none');
                $('#div-facturacion').addClass('d-none');
                $('#div-mercancias').addClass('d-none');
                $('#div-historial').addClass('d-none');

                if (container.css('display') == 'none')
                    $('#div-documentos').removeClass('d-none');
                else
                    $('#div-documentos').addClass('d-none');

            });

            $('#historial').on('click', function () {

                var container = $('#div-historial');
                $('#div-servicios').addClass('d-none');
                $('#div-requisitos').addClass('d-none');
                $('#div-mercancias').addClass('d-none');
                $('#div-facturacion').addClass('d-none');
                $('#div-documentos').addClass('d-none');

                if (container.css('display') == 'none')
                    $('#div-historial').removeClass('d-none');
                else
                    $('#div-historial').addClass('d-none');

            });
        })

        showPanel = name => {
            $('.bottomPanel').children().hide();
            $(`.${name}`).removeClass('d-none').show();
        }

        function selectServicios(element) {
            const elemento = jQuery(element);
            elemento.attr('disabled', true);
            $("#modalDiv").modal("show");
        }
        // Add the following code if you want the name of the file appear on select
        $(".custom-file-input").on("change", function () {
            var fileName = $(this).val().split("\\").pop();
            $(this).siblings(".custom-file-label").addClass("selected").html(fileName);
        });

        function UploadFile() {
            var formData = new FormData();
            var myfile = $('#customFile')[0].files[0];
            formData.append('file', $('#customFile')[0].files[0]);
            if (myfile !== undefined) {
                $.ajax({
                    url: "/Facturacion/UploadFile",
                    type: "POST",
                    data: formData,
                    contentType: false,
                    processData: false,
                    success: function (data) {
                        $("#modalDiv .close").click();
                        dToast("success", "Archivo guardado correctamente.", "Exitoso");
                        loadTableFactura();
                    },
                    error: function (data) {
                        dToast("error", "Ocurrio un error al intentar guardar el archivo.", "Error");
                    }
                });
            } else {
                dToast("error", "Seleccione un archivo.", "Error");
            }
        }

        function downloadFile(nombre, fullpath) {
            console.log({ nombre, fullpath });
            var a = $("<a>")
                .attr("href", fullpath)
                .attr("download", nombre)
                .appendTo("body");

            a[0].click();

            a.remove();
            //$.ajax({
            //    type: 'GET',
            //    url: '/Facturacion/downloadFile',
            //    data: { fileName: nombre },
            //    contentType: 'application/json; charset=utf-8',
            //    success: function (data) {
            //        console.log(data);
            //        var blob = new Blob([data]);
            //        //var blob = new Blob([data], { type: 'image/png' });
            //        var link = document.createElement('a');
            //        link.href = window.URL.createObjectURL(blob);
            //        link.download = nombre;
            //        link.click();
            //    },
            //    error: function (err) {
            //        console.log("error", err);
            //    }
            //});
        }

        function loadTableFactura() {
            var DataFacturas = [];

            var stable = $('.table-facturas').DataTable();

            stable.destroy();
            $("#table-info").empty();

            $.get("/Facturacion/getFacturas", function (res) {
                DataFacturas = res;
                res.map(({ nombre, fechacarga, usuario, fullpath }) => {
                    $("#table-info").append(`
                                                        <tr>
                                                        <td>${nombre}</td>
                                                        <td>${moment(fechacarga).format('DD/MM/YYYY')}</td>
                                                        <td>${usuario}</td>
                                                        <td class="text-center">
                                                            <a onclick="downloadFile('${nombre}','${fullpath}')">
                                                                <span class="material-icons">
                                                                    file_download
                                                                </span>
                                                            </a>
                                                        </td>
                                                    </tr>`);
                });
                dTable("table-facturas");
            }).fail(function (error) {
                dToast("error", "Error al tratar de obtener los registros, intenta cerrar sesión y volver a iniciar.", "Error");
            });
        }
    </script>
}
