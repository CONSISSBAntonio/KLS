@model KLS_WEB.Models.Monitoring.Checkpoints
<div class="modal-dialog modal-lg" role="document">
    <div class="modal-content">
        <div class="modal-header">
            <h5 class="modal-title" id="exampleModalLabel">CHECKPOINTS</h5>
            <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                <span aria-hidden="true">&times;</span>
            </button>
        </div>
        <div class="modal-body">
            <div class="row">
                <div class="col-md-12">
                    <table id="table" class="table table-striped table-bordered display table-hover table-monitoreo" width="100%">
                        <thead>
                            <tr>
                                <th>CHECKPOINT</th>
                                <th>HORA ORIGINAL</th>
                                <th>HORA ESPERADA</th>
                                <th>HORA REAL</th>
                                <th>USUARIO</th>
                                <th></th>
                            </tr>
                        </thead>
                        <tbody id="table-checkpoint-info">
                            <tr>
                                <td colspan="8">No se encontraron registros</td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
</div>
<script>
    var data = @Json.Serialize(Model);
    var fechasalida = data.fechasalida;
    var idviaje = data.idviaje;
    var idruta = data.idruta;

    var catCheckpoints = [];
    var catSecChecpoints = [];
    var horaOriginal = 0;
    var horaOriginal1 = 0;
    var fechaSalidaView = ``;

    var horaEsperadaView = ``; //La hora esperada que se mostrara en la tabla
    var horaEsperadaView1 = ``; //La hora esperada que se mostrara en la tabla
    var banderaHoraEsperada = 0;

    catCheckpoints = data.ruta_Has_Checkpoint;
    catSecChecpoints = data.section_has_checkpoint;

    if (Object.keys(catCheckpoints).length > 0) {
        $("#table-checkpoint-info").empty();
        var trInfo = `<tr>`;
        var i = 0;
        var colorCheck = "green";

        $.each(catCheckpoints, function (item, key) {
            console.log(key);
            i++;
            horaOriginal = horaOriginal + key.tiempo;
            horaOriginal1 = horaOriginal1 + key.tiempo;
            fechaSalidaView = moment(fechasalida).add(horaOriginal, 'hours').format('YYYY-MM-DD hh:mm:ss A'); //Siempre va
            var hReal, createdBy, btnActive, hEsperada = ``;
            let indice = catSecChecpoints.findIndex(service => service.idCheckpoint == key.id)
                ;
            if (indice >= 0) {
                banderaHoraEsperada = 1;
                hReal = `<td>${moment(catSecChecpoints[indice].horaReal).format('YYYY-MM-DD hh:mm:ss A')}</td>`;
                createdBy = `<td>${catSecChecpoints[indice].createdBy}</td>`;
                btnActive = `<td><button class="btn btn-sm" disabled="disabled"><span class="material-icons">save</span></button></td>`;
                horaOriginal1 = 0;
                horaEsperadaView = catSecChecpoints[indice].horaReal;
            } else {
                hReal = `<td><input type="datetime-local" class="form-control form-control-sm" id="horaReal-${idviaje}"></td>`;
                createdBy = `<td></td>`;
                btnActive = `<td>
                            <button class="btn btn-sm" onclick="saveCheckpoint(${idviaje},${key.id},${idruta},'${fechasalida}');">
                                <span class="material-icons">save</span>
                            </button>
                        </td>`;
            }

            if (parseInt(i) <= 1) {
                hEsperada = `<td>${moment(fechasalida).add(horaOriginal, 'hours').format('YYYY-MM-DD hh:mm:ss A')}</td>`;
            } else {
                if (banderaHoraEsperada == 0) {
                    hEsperada = `<td>${moment(fechasalida).add(horaOriginal1, 'hours').format('YYYY-MM-DD hh:mm:ss A')}</td>`;
                } else {
                    if (horaOriginal1 == 0) {
                        let horadif = moment(horaEsperadaView1).diff(fechaSalidaView, 'minutes');
                        horadif = horadif * 1;

                        if (horadif >= 1) {
                            colorCheck = "red";
                        }
                        let fecha = moment(fechaSalidaView).add(horadif, 'minutes').format('YYYY-MM-DD hh:mm:ss A')
                        hEsperada = `<td>${moment(fecha).add(key.tiempo, 'hours').format('YYYY-MM-DD hh:mm:ss A')}</td>`;
                    } else {
                        let horadif = moment(horaEsperadaView).diff(fechaSalidaView, 'minutes');
                        horadif = horadif * 1;

                        if (horadif >= 1) {
                            colorCheck = "red";
                        }
                        let fecha = moment(fechaSalidaView).add(horadif, 'minutes').format('YYYY-MM-DD hh:mm:ss A')
                        hEsperada = `<td>${moment(fecha).add(horaOriginal1, 'hours').format('YYYY-MM-DD hh:mm:ss A')}</td>`;
                    }
                }
            }
            trInfo += `<td> <div style="height:10px;width:10px;background:${colorCheck};-moz-border-radius:50px;-webkit-border-radius:50px;border-radius:50px;display: inline-block;"></div> ${key.nombre.toUpperCase()}</td>`;
            trInfo += `<td>${moment(fechaSalidaView).format('YYYY-MM-DD hh:mm:ss A')}</td>`;
            trInfo += hEsperada + hReal + createdBy + btnActive + `</tr>`;
            //Fin pintar tabla
            if (indice >= 0) {
                horaEsperadaView1 = catSecChecpoints[indice].horaReal;
            }
        });
        $("#table-checkpoint-info").append(trInfo);
    }

</script>